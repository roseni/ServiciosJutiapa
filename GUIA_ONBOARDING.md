# üöÄ Gu√≠a R√°pida - Sistema de Onboarding

## üìñ ¬øQu√© es el Onboarding?

El sistema de onboarding captura informaci√≥n adicional del usuario despu√©s de su registro inicial. Garantiza que todos los usuarios tengan un perfil completo antes de acceder a la aplicaci√≥n.

---

## üéØ Flujo de Usuario

### Nuevo Usuario

1. **Registro/Login** ‚Üí Usuario se autentica (Google o Email)
2. **Redirecci√≥n autom√°tica** ‚Üí Sistema detecta `onboardingStatus: "pending"`
3. **Formulario de onboarding** ‚Üí Usuario completa sus datos
4. **Validaci√≥n** ‚Üí Sistema valida los datos ingresados
5. **Guardado** ‚Üí Datos se guardan en Firestore
6. **Acceso completo** ‚Üí Usuario puede usar la aplicaci√≥n

### Usuario Existente (Onboarding Completado)

1. **Login** ‚Üí Usuario se autentica
2. **Acceso directo** ‚Üí Sistema detecta `onboardingStatus: "completed"`
3. **Aplicaci√≥n** ‚Üí Usuario accede normalmente

---

## üìã Datos Requeridos

### 1. Rol del Usuario
- **Formato:** "cliente" o "tecnico"
- **Opciones:**
  - üë§ **Cliente:** Busco contratar servicios
  - üîß **T√©cnico:** Ofrezco servicios profesionales
- **Validaci√≥n:**
  - Debe seleccionar una opci√≥n
  - Solo acepta "cliente" o "tecnico"

### 2. Nombre Completo
- **Formato:** M√≠nimo 2 palabras (nombre y apellido)
- **Ejemplo:** `Juan Carlos P√©rez L√≥pez`
- **Validaci√≥n:** 
  - Min 3 caracteres
  - Solo letras, espacios, guiones y ap√≥strofes
  - Acepta acentos (√°, √©, √≠, √≥, √∫, √±, √º)

### 3. N√∫mero de Tel√©fono (Guatemala)
- **Formato:** 8 d√≠gitos
- **Ejemplo:** `2345-6789` o `50223456789`
- **Validaci√≥n:**
  - Debe empezar con 2-7
  - 2: Fijo (Ciudad de Guatemala)
  - 3, 4, 5: M√≥viles
  - 6, 7: Fijos (otras regiones)
  - Acepta c√≥digo de pa√≠s +502

### 4. DPI (Documento Personal de Identificaci√≥n)
- **Formato:** 13 d√≠gitos
- **Ejemplo:** `1234 56789 0101`
- **Validaci√≥n:**
  - Exactamente 13 n√∫meros
  - Acepta espacios o guiones

---

## üíª Uso Program√°tico

### Verificar Estado de Onboarding

```typescript
import { hasCompletedOnboarding } from '@/lib/firebase/onboarding';

const completed = await hasCompletedOnboarding(user.uid);
if (completed) {
  // Usuario tiene onboarding completo
} else {
  // Redirigir a /onboarding
}
```

### Obtener Perfil de Usuario

```typescript
import { getUserProfile } from '@/lib/firebase/onboarding';

const profile = await getUserProfile(user.uid);
console.log(profile?.fullName);
console.log(profile?.phoneNumber);
console.log(profile?.dpi);
console.log(profile?.onboardingStatus);
```

### Completar Onboarding Manualmente

```typescript
import { completeOnboarding } from '@/lib/firebase/onboarding';

await completeOnboarding(user.uid, {
  role: "cliente",              // ‚ú® REQUERIDO
  fullName: "Juan P√©rez L√≥pez",
  phoneNumber: "23456789",
  dpi: "1234567890101"
});
```

### Usar el Store de Autenticaci√≥n

```typescript
import { useAuthStore } from '@/store/authStore';

function MyComponent() {
  const { user, userProfile } = useAuthStore();
  
  // Verificar si est√° autenticado
  if (!user) return <div>No autenticado</div>;
  
  // Verificar onboarding
  if (userProfile?.onboardingStatus === 'pending') {
    return <div>Onboarding pendiente</div>;
  }
  
  // Usuario con onboarding completo
  return (
    <div>
      <h1>Bienvenido {userProfile?.fullName}</h1>
      <p>Rol: {userProfile?.role === "cliente" ? "Cliente" : "T√©cnico"}</p>
      <p>Tel√©fono: {userProfile?.phoneNumber}</p>
    </div>
  );
}
```

---

## üîß Validaci√≥n de Datos

### Importar Validadores

```typescript
import {
  validateRole,
  validateFullName,
  validatePhoneNumber,
  validateDPI,
  validateOnboardingData
} from '@/lib/utils/onboarding-validation';
```

### Validar Rol

```typescript
const result = validateRole("cliente");
if (result.isValid) {
  console.log("Rol v√°lido");
} else {
  console.error(result.error);
}
```

### Validar Nombre

```typescript
const result = validateFullName("Juan P√©rez");
if (result.isValid) {
  console.log("Nombre v√°lido");
} else {
  console.error(result.error);
}
```

### Validar Tel√©fono

```typescript
const result = validatePhoneNumber("2345-6789");
if (result.isValid) {
  console.log("Tel√©fono v√°lido");
} else {
  console.error(result.error);
}
```

### Validar DPI

```typescript
const result = validateDPI("1234 56789 0101");
if (result.isValid) {
  console.log("DPI v√°lido");
} else {
  console.error(result.error);
}
```

### Validar Todos los Datos

```typescript
const result = validateOnboardingData({
  role: "cliente",
  fullName: "Juan P√©rez",
  phoneNumber: "23456789",
  dpi: "1234567890101"
});

if (!result.isValid) {
  alert(result.error);
}
```

---

## üé® Formateo de Datos

### Formatear Tel√©fono

```typescript
import { formatPhoneNumber } from '@/lib/utils/onboarding-validation';

const formatted = formatPhoneNumber("23456789");
// Resultado: "2345-6789"

const formatted2 = formatPhoneNumber("50223456789");
// Resultado: "502 2345-6789"
```

### Formatear DPI

```typescript
import { formatDPI } from '@/lib/utils/onboarding-validation';

const formatted = formatDPI("1234567890101");
// Resultado: "1234 56789 0101"
```

---

## üõ°Ô∏è Protecci√≥n de Rutas

### OnboardingGate

El componente `OnboardingGate` protege autom√°ticamente todas las rutas excepto `/auth` y `/onboarding`:

```typescript
// En layout.tsx (ya implementado)
<ClientAuthGate>
  <OnboardingGate>
    {children}
  </OnboardingGate>
</ClientAuthGate>
```

### Rutas Protegidas Autom√°ticamente

- ‚úÖ `/` - P√°gina principal
- ‚úÖ `/servicios` - Cualquier otra ruta
- ‚úÖ `/perfil` - Etc.

### Rutas P√∫blicas

- ‚úÖ `/auth` - Login/Registro
- ‚úÖ `/onboarding` - Formulario de onboarding

---

## üì± Ejemplos de UI

### Mostrar Datos del Usuario

```typescript
'use client';

import { useAuthStore } from '@/store/authStore';

export default function UserProfile() {
  const { userProfile } = useAuthStore();
  
  if (!userProfile) return <div>Cargando...</div>;
  
  return (
    <div className="p-4">
      <h2 className="text-xl font-bold">Mi Perfil</h2>
      <div className="mt-4 space-y-2">
        <p><strong>Rol:</strong> {userProfile.role === "cliente" ? "Cliente" : "T√©cnico"}</p>
        <p><strong>Nombre:</strong> {userProfile.fullName}</p>
        <p><strong>Email:</strong> {userProfile.email}</p>
        <p><strong>Tel√©fono:</strong> {userProfile.phoneNumber}</p>
        <p><strong>DPI:</strong> {userProfile.dpi}</p>
      </div>
    </div>
  );
}
```

### Verificar Estado Manualmente

```typescript
'use client';

import { useAuthStore } from '@/store/authStore';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

export default function ProtectedPage() {
  const { userProfile } = useAuthStore();
  const router = useRouter();
  
  useEffect(() => {
    if (userProfile?.onboardingStatus === 'pending') {
      router.push('/onboarding');
    }
  }, [userProfile, router]);
  
  return <div>Contenido protegido</div>;
}
```

---

## üîç Debugging

### Ver Estado en Console

```typescript
import { useAuthStore } from '@/store/authStore';

function DebugComponent() {
  const state = useAuthStore();
  
  console.log('User:', state.user);
  console.log('Profile:', state.userProfile);
  console.log('Onboarding Status:', state.userProfile?.onboardingStatus);
  
  return null;
}
```

### Refrescar Perfil Manualmente

```typescript
const { refreshUserProfile } = useAuthStore();

await refreshUserProfile();
```

---

## ‚ö†Ô∏è Casos Comunes

### Usuario se Registra pero no ve el Onboarding

**Verificar:**
1. ¬øEl usuario tiene `onboardingStatus: "pending"` en Firestore?
2. ¬øOnboardingGate est√° en el layout?
3. ¬øHay errores en la consola?

### Datos no se Guardan

**Verificar:**
1. ¬øLas validaciones pasan?
2. ¬øHay errores en la consola?
3. ¬øEl usuario est√° autenticado?
4. ¬øLas reglas de Firestore permiten escritura?

### Usuario Redirigido Constantemente a Onboarding

**Verificar:**
1. ¬øEl `onboardingStatus` cambi√≥ a "completed"?
2. ¬øSe llam√≥ `refreshUserProfile()` despu√©s de completar?
3. Verificar documento en Firestore

---

## üìä Estructura de Datos en Firestore

### Documento de Usuario

```javascript
// Colecci√≥n: users
// Documento ID: {uid}
{
  // Datos b√°sicos (de Auth)
  uid: "abc123",
  email: "usuario@example.com",
  displayName: "Usuario",
  photoURL: "https://...",
  provider: "google.com",
  
  // Datos de onboarding
  onboardingStatus: "completed", // o "pending"
  role: "cliente", // o "tecnico"
  fullName: "Juan Carlos P√©rez L√≥pez",
  phoneNumber: "23456789", // Sin formato
  dpi: "1234567890101", // Sin formato
  
  // Timestamps
  createdAt: Timestamp,
  updatedAt: Timestamp,
  onboardingCompletedAt: Timestamp
}
```

---

## üß™ Testing

### Ejecutar Tests de Onboarding

```bash
# Todos los tests
pnpm test

# Solo tests de onboarding
pnpm test onboarding-validation
```

### Tests Disponibles

- ‚úÖ Validaci√≥n de nombre completo (6 tests)
- ‚úÖ Validaci√≥n de tel√©fono (3 tests)
- ‚úÖ Validaci√≥n de DPI (4 tests)
- ‚úÖ Validaci√≥n combinada (2 tests)
- ‚úÖ Formateo (4 tests)

**Total: 19 tests de onboarding**

---

## üìö Referencias

### Archivos Principales

- **P√°gina:** `src/app/onboarding/page.tsx`
- **Servicio:** `src/lib/firebase/onboarding.ts`
- **Validaciones:** `src/lib/utils/onboarding-validation.ts`
- **Gate:** `src/components/autenticacion/OnboardingGate.tsx`
- **Store:** `src/store/authStore.ts`

### Documentaci√≥n Completa

- `ONBOARDING_SYSTEM.md` - Documentaci√≥n t√©cnica completa
- `RESUMEN_FINAL.md` - Resumen ejecutivo del proyecto
- `GUIA_ONBOARDING.md` - Esta gu√≠a

---

## üéØ Tips y Mejores Pr√°cticas

### ‚úÖ DO

- Usar las funciones de validaci√≥n antes de enviar datos
- Verificar `userProfile.onboardingStatus` para l√≥gica condicional
- Llamar `refreshUserProfile()` despu√©s de cambios importantes
- Manejar estados de carga apropiadamente

### ‚ùå DON'T

- No modificar datos de onboarding directamente en Firestore
- No saltarse validaciones
- No asumir que el perfil siempre existe (usar optional chaining)
- No hacer m√∫ltiples llamadas innecesarias a `refreshUserProfile()`

---

## üöÄ Listo para Usar

El sistema de onboarding est√° **completamente funcional** y listo para:

- ‚úÖ Capturar datos de nuevos usuarios
- ‚úÖ Validar informaci√≥n correctamente
- ‚úÖ Proteger rutas autom√°ticamente
- ‚úÖ Proporcionar excelente UX
- ‚úÖ Escalar con nuevos campos

**¬°Todo est√° listo para comenzar a desarrollar!** üéâ
